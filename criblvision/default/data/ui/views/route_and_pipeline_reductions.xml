<form theme="dark" version="1.1">
  <label>Route/Pipeline Reductions</label>
  <search id="io_summary_base_search">
    <query>| mstats sum(`set_cribl_metrics_prefix($metric$.*)`) AS * WHERE `set_cribl_metrics_index` $environment_filter$ $host_filter$ $worker_group_metric_pre_filter$ $metric_group_by$=$selected$ BY host group fillnull_value=`set_unknown_worker_group_value`
| lookup cribl_stream_assets host OUTPUTNEW instance_type worker_group
| search $worker_group_event_filter$ $worker_group_metric_filter$
| stats sum(*_bytes) AS *_bytes sum(*_events) AS *_events</query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <search id="io_time_summary_base_search">
    <query>| mstats sum(`set_cribl_metrics_prefix($metric$.*)`) AS * WHERE `set_cribl_metrics_index` $environment_filter$ $host_filter$ $worker_group_metric_pre_filter$ $metric_group_by$=$selected$ BY host group span=auto fillnull_value=`set_unknown_worker_group_value`
| lookup cribl_stream_assets host OUTPUTNEW instance_type worker_group
| search $worker_group_event_filter$ $worker_group_metric_filter$
| stats sum(*_bytes) AS *_bytes sum(*_events) AS *_events BY _time
| rename in_bytes AS "Bytes In" out_bytes AS "Bytes Out" in_events AS "Events In" out_events AS "Events Out"</query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <search id="io_breakdown_base_search">
    <query>| mstats sum(`set_cribl_metrics_prefix($metric$.*)`) AS * WHERE `set_cribl_metrics_index` $environment_filter$ $host_filter$ $worker_group_metric_pre_filter$ $metric_group_by$=$selected$ BY host group $metric_group_by$ fillnull_value=`set_unknown_worker_group_value`
| lookup cribl_stream_assets host OUTPUTNEW instance_type worker_group
| search $worker_group_event_filter$ $worker_group_metric_filter$
| stats sum(*_bytes) AS *_bytes sum(*_events) AS *_events BY $metric_group_by$ instance_type worker_group</query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <search id="annotation_search" ref="Deployment Annotations">
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <fieldset submitButton="true" autoRun="false">
    <input type="time" token="time" searchWhenChanged="true">
      <label>Time Range</label>
      <default>
        <earliest>-15m</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="environment" searchWhenChanged="true">
      <label>Environment</label>
      <choice value="*">All Environments</choice>
      <fieldForLabel>environment</fieldForLabel>
      <fieldForValue>hosts</fieldForValue>
      <search>
        <query>| `dashboard_cribl_environment_filter`</query>
        <earliest>-1m@m</earliest>
        <latest>now</latest>
      </search>
      <change>
        <condition label="All Environments">
          <set token="environment_filter"></set>
        </condition>
        <condition>
          <set token="environment_filter">host IN ($environment$)</set>
        </condition>
      </change>
      <default>*</default>
      <initialValue>*</initialValue>
    </input>
    <input type="dropdown" token="worker_group" searchWhenChanged="true">
      <label>Worker Group / Fleet / Single</label>
      <choice value="all_instances">All Instances</choice>
      <choice value="all_worker_groups">All Worker Groups</choice>
      <choice value="all_single">All Single Instances</choice>
      <fieldForLabel>label</fieldForLabel>
      <fieldForValue>worker_group</fieldForValue>
      <search>
        <query>| `dashboard_worker_group_filter($environment_filter|s$)`</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </search>
      <change>
        <condition label="All Instances">
          <set token="worker_group_event_filter">instance_type IN (worker, single)</set>
          <set token="worker_group_metric_pre_filter"></set>
          <set token="worker_group_metric_filter">group=*</set>
        </condition>
        <condition label="All Worker Groups">
          <set token="worker_group_event_filter">instance_type=worker</set>
          <set token="worker_group_metric_pre_filter">group=*</set>
          <set token="worker_group_metric_filter">group=*</set>
        </condition>
        <condition label="All Single Instances">
          <set token="worker_group_event_filter">instance_type=single</set>
          <set token="worker_group_metric_pre_filter"></set>
          <set token="worker_group_metric_filter">group=`set_unknown_worker_group_value`</set>
        </condition>
        <condition>
          <set token="worker_group_event_filter">instance_type=worker worker_group="$worker_group$"</set>
          <set token="worker_group_metric_pre_filter">group="$worker_group$"</set>
          <set token="worker_group_metric_filter">group="$worker_group$"</set>
        </condition>
      </change>
      <default>all_instances</default>
      <initialValue>all_instances</initialValue>
    </input>
    <input type="dropdown" token="host">
      <label>Host</label>
      <fieldForLabel>label</fieldForLabel>
      <fieldForValue>host</fieldForValue>
      <search>
        <query>| `dashboard_host_filter($environment_filter|s$ $worker_group_event_filter|s$)`</query>
        <earliest>$time.earliest$</earliest>
        <latest>$time.latest$</latest>
      </search>
      <choice value="*">All Hosts</choice>
      <default>*</default>
      <initialValue>*</initialValue>
      <change>
        <condition>
          <set token="host_filter">host="$host$"</set>
        </condition>
      </change>
    </input>
    <input type="dropdown" token="metric" searchWhenChanged="true">
      <label>Show Routes or Pipelines</label>
      <choice value="route">Route</choice>
      <choice value="pipe">Pipeline</choice>
      <change>
        <condition>
          <eval token="metric_group_by">if(label == "Route", "name", "id")</eval>
          <eval token="show_byte_io">if(label == "Route", "true", null())</eval>
          <eval token="selected_label">label</eval>
        </condition>
      </change>
      <default>route</default>
      <initialValue>route</initialValue>
    </input>
    <input type="dropdown" token="selected" searchWhenChanged="true">
      <label>Route / Pipeline</label>
      <choice value="*">All</choice>
      <default>*</default>
      <initialValue>*</initialValue>
      <fieldForLabel>$metric_group_by$</fieldForLabel>
      <fieldForValue>$metric_group_by$</fieldForValue>
      <search>
        <query>| mstats sum(`set_cribl_metrics_prefix($metric$.*)`) AS * WHERE `set_cribl_metrics_index` BY $metric_group_by$</query>
        <earliest>-15m</earliest>
        <latest>now</latest>
      </search>
    </input>
    <input type="link" token="how_to_use">
      <label>How to Use</label>
      <choice value="show">Show</choice>
      <choice value="hide">Hide</choice>
      <default>hide</default>
      <initialValue>hide</initialValue>
      <change>
        <eval token="show_details">if(label == "Show", "true", null())</eval>
      </change>
    </input>
  </fieldset>
  <row>
    <panel depends="$show_details$">
      <html>
        <div style="font-family: Arial; font-size: 11pt; list-style-type: square; text-align: center;">
          <p>This dashboard displays an overview of the byte/event I/O across either Routes or Pipelines, along with any reduction in bytes/events observed. A breakdown of I/O per Route/Pipeline is provided to investigate the reduction (or lack thereof) across Cribl Stream.</p>
          <p><b>Note:</b>Pipelines do not report bytes I/O metrics, therefore only information relating to event I/O is presented for Pipelines.</p>
        </div>
      </html>
    </panel>
  </row>
  <row>
    <panel depends="$show_byte_io$">
      <single>
        <title>Total Bytes In</title>
        <search base="io_summary_base_search">
          <query>
| table in_bytes</query>
        </search>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0xB88073","0xB88073"]</option>
        <option name="rangeValues">[0]</option>
        <option name="unit">B</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel depends="$show_byte_io$">
      <single>
        <title>Total Bytes Out</title>
        <search base="io_summary_base_search">
          <query>
| table out_bytes</query>
        </search>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0xE38E6F","0xE38E6F"]</option>
        <option name="rangeValues">[0]</option>
        <option name="unit">B</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Total Events In</title>
        <search base="io_summary_base_search">
          <query>
| table in_events</query>
        </search>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x2A6293","0x2A6293"]</option>
        <option name="rangeValues">[0]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Total Events Out</title>
        <search base="io_summary_base_search">
          <query>
| table out_events</query>
        </search>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x78A1C1","0x78A1C1"]</option>
        <option name="rangeValues">[0]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>
  <row>
    <panel depends="$show_byte_io$">
      <single>
        <title>Total Bytes Reduced</title>
        <search base="io_summary_base_search">
          <query>
| eval bytes_reduced = in_bytes - out_bytes
| table bytes_reduced</query>
        </search>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0xd41f1f","0x118832"]</option>
        <option name="rangeValues">[0]</option>
        <option name="refresh.display">progressbar</option>
        <option name="unit">B</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel depends="$show_byte_io$">
      <single>
        <title>Percentage of Bytes Reduced</title>
        <search base="io_summary_base_search">
          <query>
| eval bytes_reduced_pct = ((in_bytes - out_bytes) / in_bytes) * 100
| table bytes_reduced_pct</query>
        </search>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.00</option>
        <option name="rangeColors">["0xd41f1f","0x118832"]</option>
        <option name="rangeValues">[0]</option>
        <option name="refresh.display">progressbar</option>
        <option name="unit">%</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Total Events Reduced</title>
        <search base="io_summary_base_search">
          <query>
| eval events_reduced = in_events - out_events
| table events_reduced</query>
        </search>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0xd41f1f","0x118832"]</option>
        <option name="rangeValues">[0]</option>
        <option name="refresh.display">progressbar</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Percentage of Events Reduced</title>
        <search base="io_summary_base_search">
          <query>
| eval events_reduced_pct = ((in_events - out_events) / in_events) * 100
| table events_reduced_pct</query>
        </search>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.00</option>
        <option name="rangeColors">["0xd41f1f","0x118832"]</option>
        <option name="rangeValues">[0]</option>
        <option name="refresh.display">progressbar</option>
        <option name="unit">%</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>
  <row>
    <panel depends="$show_byte_io$">
      <chart>
        <title>Bytes I/O Over Time</title>
        <search base="io_time_summary_base_search">
          <query>
| table _time Bytes*</query>
        </search>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Bytes I/O</option>
        <option name="charting.chart">area</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.fieldColors">{"Bytes In":"0xB88073","Bytes Out":"0xE38E6F"}</option>
        <option name="charting.legend.placement">bottom</option>
      </chart>
    </panel>
    <panel>
      <chart>
        <title>Events I/O Over Time</title>
        <search base="io_time_summary_base_search">
          <query>
| table _time Events*</query>
        </search>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Events I/O</option>
        <option name="charting.chart">area</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.fieldColors">{"Events In":"0x2A6293","Events Out":"0x78A1C1"}</option>
        <option name="charting.legend.placement">bottom</option>
      </chart>
    </panel>
  </row>
  <row depends="$show_byte_io$">
    <panel>
      <table>
        <title>Breakdown of Bytes I/O by $selected_label$</title>
        <search base="io_breakdown_base_search">
          <query>
| eval bytes_reduced = in_bytes - out_bytes, bytes_reduced_pct = (bytes_reduced / in_bytes) * 100
| table $metric_group_by$ instance_type worker_group in_bytes out_bytes bytes_reduced bytes_reduced_pct
| rename name AS Route id AS Pipeline instance_type AS "Instance Type" worker_group AS "Worker Group" in_bytes AS "Bytes In" out_bytes AS "Bytes Out" bytes_reduced AS "Bytes Reduced" bytes_reduced_pct AS "Bytes Reduced %"
          </query>
        </search>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">true</option>
        <format type="number" field="Bytes In">
          <option name="precision">0</option>
          <option name="unit">B</option>
        </format>
        <format type="number" field="Bytes Out">
          <option name="precision">0</option>
          <option name="unit">B</option>
        </format>
        <format type="number" field="Bytes Reduced">
          <option name="precision">0</option>
          <option name="unit">B</option>
        </format>
        <format type="number" field="Bytes Reduced %">
          <option name="unit">%</option>
        </format>
        <format type="color" field="Bytes In">
          <colorPalette type="expression">"#B88073"</colorPalette>
        </format>
        <format type="color" field="Bytes Out">
          <colorPalette type="expression">"#E38E6F"</colorPalette>
        </format>
        <format type="color" field="Bytes Reduced">
          <colorPalette type="expression">if(value &lt;= 0, "#D41F1F", "#118832")</colorPalette>
        </format>
        <format type="color" field="Bytes Reduced %">
          <colorPalette type="expression">if(value &lt;= 0, "#D41F1F", "#118832")</colorPalette>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <title>Breakdown of Event I/O by $selected_label$</title>
        <search base="io_breakdown_base_search">
          <query>
| eval events_reduced = in_events - out_events, events_reduced_pct = (events_reduced / in_events) * 100
| table $metric_group_by$ instance_type worker_group in_events out_events events_reduced events_reduced_pct
| rename name AS Route id AS Pipeline instance_type AS "Instance Type" worker_group AS "Worker Group" in_events AS "Events In" out_events AS "Events Out" events_reduced AS "Events Reduced" events_reduced_pct AS "Events Reduced %"
          </query>
        </search>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">true</option>
        <format type="number" field="Events In">
          <option name="precision">0</option>
        </format>
        <format type="number" field="Events Out">
          <option name="precision">0</option>
        </format>
        <format type="number" field="Events Reduced">
          <option name="precision">0</option>
        </format>
        <format type="number" field="Events Reduced %">
          <option name="unit">%</option>
        </format>
        <format type="color" field="Events In">
          <colorPalette type="expression">"#2A6293"</colorPalette>
        </format>
        <format type="color" field="Events Out">
          <colorPalette type="expression">"#78A1C1"</colorPalette>
        </format>
        <format type="color" field="Events Reduced">
          <colorPalette type="expression">if(value &lt;= 0, "#D41F1F", "#118832")</colorPalette>
        </format>
        <format type="color" field="Events Reduced %">
          <colorPalette type="expression">if(value &lt;= 0, "#D41F1F", "#118832")</colorPalette>
        </format>
      </table>
    </panel>
  </row>
</form>