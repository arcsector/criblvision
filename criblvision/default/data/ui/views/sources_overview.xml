<form theme="dark" version="1.1">
  <label>Sources Overview</label>
  <fieldset submitButton="true" autoRun="false">
    <input type="time" token="time" searchWhenChanged="true">
      <label>Time Range</label>
      <default>
        <earliest>-15m</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="worker_group">
      <label>Worker Group</label>
      <choice value="*">All Worker Groups</choice>
      <initialValue>*</initialValue>
      <fieldForLabel>worker_group</fieldForLabel>
      <fieldForValue>worker_group</fieldForValue>
      <search>
        <query>| inputlookup cribl_stream_workers | stats count BY worker_group</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </search>
    </input>
    <input type="dropdown" token="host">
      <label>Host</label>
      <fieldForLabel>host</fieldForLabel>
      <fieldForValue>host</fieldForValue>
      <search>
        <query>| tstats values(host) as host where `set_cribl_internal_log_index` | mvexpand host | sort host | lookup cribl_stream_workers worker AS host | search worker_group=$worker_group$</query>
        <earliest>$time.earliest$</earliest>
        <latest>$time.latest$</latest>
      </search>
      <choice value="*">All Hosts</choice>
      <default>*</default>
      <initialValue>*</initialValue>
    </input>
    <input type="link" token="how_to_use">
      <label>How to Use</label>
      <choice value="show">Show</choice>
      <choice value="hide">Hide</choice>
      <default>hide</default>
      <initialValue>hide</initialValue>
      <change>
        <condition label="Show">
          <set token="show_details">true</set>
        </condition>
        <condition>
          <unset token="show_details"></unset>
        </condition>
      </change>
    </input>
  </fieldset>
  <row>
    <panel depends="$show_details$">
      <html>
        <div style="font-family: Arial; font-size: 11pt; list-style-type: square; text-align: center;">
          <p>This dashboard displays an overview of log based statistics for all of your configured Sources. It shows percentages in relation to the total count of events, of <code>error</code>, <code>warn</code>, and <code>info</code> level events. The bottom panels split out the percentages by <code>channel</code> and display <code>error</code> counts by <code>channel</code>. It is useful for getting a high level overview of the health of your Sources.</p>
        </div>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>% of Error Messages Across all Sources</title>
      <single>
        <search>
          <query>`set_cribl_internal_log_index` host=$host$ worker_group=$worker_group$ cid=* channel=input* | stats count AS "Total", count(eval(match(level,"error"))) AS errorcount | eval error_percentage=(errorcount/Total)*100| table error_percentage</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">none</option>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.00</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="rangeValues">[0,30,70,100]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="trendDisplayMode">absolute</option>
        <option name="unit">%</option>
        <option name="unitPosition">after</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>% of Warn Messages Across all Sources</title>
      <single>
        <search>
          <query>`set_cribl_internal_log_index` host=$host$ worker_group=$worker_group$ cid=* channel=input* | stats count AS "Total", count(eval(match(level,"warn"))) AS warncount | eval warn_percentage=(warncount/Total)*100| table warn_percentage</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">none</option>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.00</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="rangeValues">[0,30,70,100]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="trendDisplayMode">absolute</option>
        <option name="unit">%</option>
        <option name="unitPosition">after</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>% of Info Messages Across all Sources</title>
      <single>
        <search>
          <query>`set_cribl_internal_log_index` host=$host$ worker_group=$worker_group$ cid=* channel=input* | stats count AS "Total", count(eval(match(level,"info"))) AS infocount | eval info_percentage=(infocount/Total)*100| table info_percentage</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">none</option>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.00</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="rangeValues">[0,30,70,100]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="trendDisplayMode">absolute</option>
        <option name="unit">%</option>
        <option name="unitPosition">after</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <title>$loglevel1$ Log Level Percentage Counts by Channel</title>
      <input type="dropdown" token="loglevel1">
        <label>Log Level</label>
        <choice value="error">Error</choice>
        <choice value="warn">Warn</choice>
        <choice value="info">Info</choice>
        <default>error</default>
      </input>
      <table>
        <search>
          <query>`set_cribl_internal_log_index` host=$host$ worker_group=$worker_group$ cid=* channel=input* | stats count AS "Total", count(eval(match(level,"$loglevel1$"))) AS $loglevel1$count by channel | eval $loglevel1$_percentage=($loglevel1$count/Total)*100| table $loglevel1$_percentage channel 
| sort -error_percentage | rename error_percentage AS "Error %" channel AS Channel</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format type="number" field="Error %">
          <option name="unit">%</option>
        </format>
      </table>
    </panel>
    <panel>
      <title>$loglevel2$ Counts by Channel</title>
      <input type="dropdown" token="loglevel2" searchWhenChanged="true">
        <label>Log Level</label>
        <choice value="error">Error</choice>
        <choice value="warn">Warn</choice>
        <choice value="info">Info</choice>
        <default>error</default>
      </input>
      <table>
        <search>
          <query>`set_cribl_internal_log_index` host=$host$ worker_group=$worker_group$ level=$loglevel2$ cid=* channel=input* | chart count sparkline by channel | sort -count | rename channel AS Channel count AS Count sparkline AS Sparkline</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format type="number" field="Count">
          <option name="precision">0</option>
        </format>
      </table>
    </panel>
  </row>
</form>